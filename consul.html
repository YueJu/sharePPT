<!doctype html>
<html lang="en">

	<head>
		<meta charset="utf-8">

		<title>reveal.js – The HTML Presentation Framework</title>

		<meta name="description" content="A framework for easily creating beautiful presentations using HTML">
		<meta name="author" content="Hakim El Hattab">

		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<link rel="stylesheet" href="css/reveal.css">
		<link rel="stylesheet" href="css/theme/black.css" id="theme">

		<!-- Theme used for syntax highlighting of code -->
		<link rel="stylesheet" href="lib/css/zenburn.css">

		<!-- Printing and PDF exports -->
		<script>
			var link = document.createElement( 'link' );
			link.rel = 'stylesheet';
			link.type = 'text/css';
			link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
			document.getElementsByTagName( 'head' )[0].appendChild( link );
		</script>

		<!--[if lt IE 9]>
		<script src="lib/js/html5shiv.js"></script>
		<![endif]-->
	</head>

	<body>

		<div class="reveal">

			<!-- Any section element inside of this container is displayed as a slide -->
			<div class="slides">
				<section>
					<h1>consul的服务注册与发现机制</h1>
<!-- 					<h3>The HTML Presentation Framework</h3> -->
					<p>
						<small>Created by <a href="https://github.com/YueJu">Ju</a></small>
					</p>
<!-- 					<script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?serve=CKYI553M&placement=revealjscom" id="_carbonads_js"></script> -->
				</section>

				<section>
					<h2>HashiCorp 公司</h2>
					<h3 class="fragment">
						Go语言
					</h3>
					<p class="fragment">
						天然可移植
					</p>
				</section>

				<!-- Example of nested vertical slides -->
				<section>
					<section>
						<h2>五大特性</h2>
						<p>多数据中心</p>
						<p>Raft算法</p>
						<p>Key/Value 存储</p>
						<p>服务发现</p>
						<p>...</p>
						<br>
						<!-- <a href="#" class="navigate-down">
							<img width="178" height="238" data-src="https://s3.amazonaws.com/hakim-static/reveal-js/arrow.png" alt="Down arrow">
						</a> -->
					</section>
					<section>
						<h2>多数据中心</h2>
						<p class="fragment">避免单数据中心的单点故障</p>
						<p class="fragment">内外网的服务采用不同端口进行监听</p>
						<p class="fragment">部署需要考虑网络延迟, 分片等情况等</p>
					</section>
					<section data-background="url(images/datacenter12.png)" data-background-repeat="repeat"  data-background-size="1300px">
					</section>					
					<section>
						<h2>GOSSIP 协议</h2>
						<p>管理成员和广播消息到集群</p>
						<p> LAN gossip池 <span class="fragment">client & server</span></p>
						<p> WAN gossip池 <span class="fragment">是全局唯一的</span></p>
						<aside class="notes">成员关系运行client自动发现server，减少配置量；分布式的故障检测允许故障检测的工作由整个集群承担，而不是集中在少数server上；最后gossip池允许可靠和快速的事件广播，比如leader选举。

						所有的server都应该加入WAN池，不论是哪个数据中心的。WAN池提供的成员关系允许server执行跨数据中心请求。集成的故障检测允许Consul优雅的处理整个数据中心失联，或者远程数据中心只有一个server。</aside>
					</section>
					<section>
						<h2>Raft算法</h2>
						<p><span class="fragment highlight-red">Consensus一致性</span></p>
						<aside class="notes">
							多个服务器在状态达成一致，但是在一个分布式系统中，因为各种意外可能，有的服务器可能会崩溃或变得不可靠，它就不能和其他服务器达成一致状态。这样就需要一种Consensus协议，一致性协议是为了确保容错性，也就是即使系统中有一两个服务器宕机，也不会影响其处理过程。
						</aside>
						<p>角色： <span class="fragment highlight-red">Leader</span> <span class="fragment highlight-blue">Follower</span> <span class="fragment highlight-green">Candidate</span></p>
					</section>
					<section data-background="url(images/raft.png)" data-background-repeat="repeat"  data-background-size="1300px">
					</section>
					<section>
						<h2>健康检查</h2>
						<p>监控每台主机、每个微服务实例的健康状态</p>
						<p>五种健康检测方式</p>
					</section>
					<section data-markdown>
						<script type="text/template">
						## Script+Interval

						通过执行外部脚本来进行健康检测。脚本按照指定时间来进行循环调用（比如30s调用一次）。脚本默认超时时间是30s，可以通过timeout来指定。

						```
						{
							"check": {
								"id": "mem-util",
								"name": "Memory utilization",
							    "args": ["/usr/local/bin/check_mem.py", "-limit", "256MB"],
							    "interval": "10s",
							    "timeout": "1s"
							}
						}
						```
						</script>
					</section>
					<section data-markdown>
						<script type="text/template">
						## Http+Interval

						按照预设的时间间隔创建一个HTTP GET请求。HTTP响应代码来标识服务状态：2xx代码视为正常，429表示警告，有很多请求；其他值表示失败。Http默认超时时间为Interval中指定的时间，最大为10秒。

						```
						{
							"check": {
							    "id": "api",
							    "name": "HTTP API on port 5000",
							    "http": "https://localhost:5000/health",
							    "tls_skip_verify": false,
							    "method": "POST",
							    "header": {"x-foo":["bar", "baz"]},
							    "interval": "10s",
							    "timeout": "1s"
							}
						}
						```
					</script>
					</section>
					<section data-markdown>
						<script type="text/template">
						## TCP + Interval

						将按照预设的时间间隔与指定的IP/Hostname和端口创建一个TCP连接。服务的状态依赖于TCP连接是否成功——如果连接成功，则状态是“success”；否则状态是“critical”。
						<!-- 如果一个Hostname解析为一个IPv4和一个IPv6，将尝试连接这两个地址，第一次连接成功则服务状态是“success”。
						如果希望通过这种方式利用外部脚本执行健康检查，那么脚本应该采用“netcat”或者简单的socket操作。 -->
						默认情况下，TCP checks中，请求超时时间等于调用请求的间隔时间，最大10秒。<!-- 也是可以自由配置的。 -->

						```
						{
							"check": {
							    "id": "ssh",
							    "name": "SSH TCP on port 22",
							    "tcp": "localhost:22",
							    "interval": "10s",
							    "timeout": "1s"
							}
						}
						```
						</script>
					</section>
					<section data-markdown>
						<script type="text/template">
						## Time to Live (TTL)

						这种checks为给定TTL保留了最后一种状态，checks的状态必须通过HTTP接口周期性更新，如果外部接口没有更新状态，那么状态就会被认定为不正常。
						```
						{
							"check": {
								"id": "web-app",
							    "name": "Web App Status",
							    "notes": "Web app does a curl internally every 10 seconds",
							    "ttl": "30s"
							}
						}
						```
						</script>
						<aside class="notes">
						这种机制，在概念上类似“死人开关”，需要服务周期性汇报健康状态。比如，一个健康的APP可以周期性的将状态put到HTTP端；如果app出问题了，那么TTL将过期，健康检查将进入Critical状态。用来为给定check更新健康信息的endpoint都是pass endpoint和fail endpoint。（参见agent http endpoint）
						TTL checks会将其最后已知状态更新至磁盘，这允许Agent通过重启后恢复到已知的状态。通过TTL端上一次check来维持健康状态的有效性。
						</aside>
					</section>
					<section data-markdown>
						<script type="text/template">
						## Docker+ interval

						这种检查依赖于调用封装在docker容器内的外部程序。运行的docker通过docker Exec API来触发外部应用。Consul使用$DOCKER_HOST来确定Docker 
						API端点。应用程序将运行，并对在容器内运行的服务执行健康检查。Check按照指定的时间间隔调用。
						```
						{
							"check": {
								"id": "mem-util",
							    "name": "Memory utilization",
							    "docker_container_id": "f972c95ebf0e",
							    "shell": "/bin/bash",
							    "args": ["/usr/local/bin/check_mem.py"],
							    "interval": "10s"
							}
						}
						```
					</script>
					</section><!-- 
					<section>
						<h2>ACL 访问控制</h2>
						<p>Nested slides are useful for adding additional detail underneath a high level horizontal slide.</p>
					</section> -->
					<section>
						<h2>服务发现</h2>
						<p class="fragment">原理</p>
					</section>					
					<section data-background="url(images/service.png)" data-background-repeat="repeat"  data-background-size="1300px">
					</section>	
					<section>
						<h2>That's it, time to go back up.</h2>
						<br>
						<a href="#/2">
							<img width="178" height="238" data-src="https://s3.amazonaws.com/hakim-static/reveal-js/arrow.png" alt="Up arrow" style="transform: rotate(180deg); -webkit-transform: rotate(180deg);">
						</a>
					</section>
				</section>

				<section>
					<h2>Q & A</h2>
					<p>
						Press <strong>ESC</strong> to enter the slide overview.
					</p>
				</section>				

				<section style="text-align: left;">
					<h1>THE END</h1>
					<p>
						- <a href="https://slides.com">Try the online editor</a> <br>
						- <a href="https://github.com/hakimel/reveal.js">Source code &amp; documentation</a>
					</p>
				</section>

			</div>

		</div>

		<script src="lib/js/head.min.js"></script>
		<script src="js/reveal.js"></script>

		<script>

			// More info https://github.com/hakimel/reveal.js#configuration
			Reveal.initialize({
				controls: true,
				progress: true,
				history: true,
				center: true,

				transition: 'slide', // none/fade/slide/convex/concave/zoom

				// More info https://github.com/hakimel/reveal.js#dependencies
				dependencies: [
					{ src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
					{ src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
					{ src: 'plugin/search/search.js', async: true },
					{ src: 'plugin/zoom-js/zoom.js', async: true },
					{ src: 'plugin/notes/notes.js', async: true }
				]
			});

		</script>

		<!-- Everything below this point is only used for the reveal.js demo page -->

		<a class="fork-reveal" style="display: none;" href="https://github.com/hakimel/reveal.js"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://github-camo.global.ssl.fastly.net/365986a132ccd6a44c23a9169022c0b5c890c387/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f7265645f6161303030302e706e67" alt="Fork reveal.js on GitHub"></a>

		<!--<div class="share-reveal" style="display: none; position: absolute; bottom: 16px; left: 50%; margin-left: -139px; z-index: 20;">
			<a class="share-reveal-editor" href="https://slides.com">Try the online editor</a>

			<a class="share-reveal-facebook" href="http://www.facebook.com/sharer.php?u=http%3A%2F%2Frevealjs.com">
				<svg viewBox="-8 -8 48 48" width="20" height="20" version="1.1" xmlns="http://www.w3.org/2000/svg">
					<path fill="#FFFFFF" d="M25.613-4.557c0,0-3.707,0-6.166,0c-3.662,0-7.732,1.535-7.732,6.835c0.019,1.845,0,3.613,0,5.603H7.481 v6.728h4.366v19.37h8.021V14.48h5.295l0.479-6.618h-5.913c0,0,0.016-2.946,0-3.8c0-2.093,2.184-1.974,2.312-1.974 c1.042,0,3.059,0.003,3.578,0v-6.646H25.613z"/>
				</svg>
			</a>

			<a class="share-reveal-twitter" href="http://twitter.com/share?url=http%3A%2F%2Frevealjs.com&text=reveal.js%20-%20The%20HTML%20presentation%20framework&via=revealjs&related=revealjs">
				<svg viewbox="0 0 2000 1625.36" width="20" height="20" version="1.1" xmlns="http://www.w3.org/2000/svg">
					<path d="m 1999.9999,192.4 c -73.58,32.64 -152.67,54.69 -235.66,64.61 84.7,-50.78 149.77,-131.19 180.41,-227.01 -79.29,47.03 -167.1,81.17 -260.57,99.57 C 1609.3399,49.82 1502.6999,0 1384.6799,0 c -226.6,0 -410.328,183.71 -410.328,410.31 0,32.16 3.628,63.48 10.625,93.51 -341.016,-17.11 -643.368,-180.47 -845.739,-428.72 -35.324,60.6 -55.5583,131.09 -55.5583,206.29 0,142.36 72.4373,267.95 182.5433,341.53 -67.262,-2.13 -130.535,-20.59 -185.8519,-51.32 -0.039,1.71 -0.039,3.42 -0.039,5.16 0,198.803 141.441,364.635 329.145,402.342 -34.426,9.375 -70.676,14.395 -108.098,14.395 -26.441,0 -52.145,-2.578 -77.203,-7.364 52.215,163.008 203.75,281.649 383.304,284.946 -140.429,110.062 -317.351,175.66 -509.5972,175.66 -33.1211,0 -65.7851,-1.949 -97.8828,-5.738 181.586,116.4176 397.27,184.359 628.988,184.359 754.732,0 1167.462,-625.238 1167.462,-1167.47 0,-17.79 -0.41,-35.48 -1.2,-53.08 80.1799,-57.86 149.7399,-130.12 204.7499,-212.41" style="fill:#ffffff"/>
				</svg>
			</a>
		</div>-->

		<style>
			/* Social sharing */
			.share-reveal a {
				display: inline-block;
				height: 34px;
				line-height: 32px;
				padding: 0 10px;
				color: #fff;
				font-family: Helvetica, sans-serif;
				text-decoration: none;
				font-weight: bold;
				font-size: 12px;
				vertical-align: top;
				text-transform: uppercase;
				box-sizing: border-box;
			}

			.share-reveal .share-reveal-editor {
				line-height: 30px;
			}

			.share-reveal svg {
				vertical-align: middle;
			}

			.share-reveal a + a {
				margin-left: 10px;
			}

			.share-reveal-editor {
				border: 2px solid #fff;
			}

			.share-reveal-twitter,
			.share-reveal-follow {
				background-color: #00aced;
			}

			.share-reveal-facebook {
				background-color: #4B71B8;
			}

			/* Advertising */
			#carbonads {
				width: 370px;
				min-height: 100px;
				font-size: 18px;
				border: 1px solid rgba(255, 255, 255, 0.2);
				padding: 10px;
				margin: 40px auto 0 auto;
				font-size: 16px;
				z-index: 10;
				text-align: left;
			}

			#carbonads .carbon-img img {
				float: left;
				margin: 0 10px 0 0;
				border: 0;
				box-shadow: none;
			}

			#carbonads .carbon-poweredby {
				display: block;
				margin-top: 10px;
				color: #aaa;
			}
		</style>

		<script>
		var _gaq = [['_setAccount', 'UA-15240703-1'], ['_trackPageview']];
		(function(d, t) {
		var g = d.createElement(t),
			s = d.getElementsByTagName(t)[0];
		g.async = true;
		g.src = ('https:' == location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
		s.parentNode.insertBefore(g, s);
		})(document, 'script');
		</script>

		<script>
			[].slice.call( document.querySelectorAll( '.share-reveal-facebook, .share-reveal-twitter' ) ).forEach( function( element ) {
				element.addEventListener( 'click', function( event ) {
					event.preventDefault();
					var width = 500, height = 300;
					var winTop = window.screenY + (window.screen.height / 2) - (height / 2);
					var winLeft = window.screenX + (window.screen.width / 2) - (width / 2);
					window.open(this.href, 'shre', 'top=' + winTop + ',left=' + winLeft + ',toolbar=0,status=0,width=' + width + ',height=' + height);
				} );
			} );

			if( !navigator.userAgent.match( /(iphone|android)/gi ) && !!document.querySelector ) {
				// document.querySelector( '.share-reveal' ).style.display = 'block';
				document.querySelector( '.fork-reveal' ).style.display = 'none';
			}
		</script>

	</body>
</html>
